<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard | Interview Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4 text-center">ðŸ‘¤ User Dashboard</h1>

    <!-- Profile Info -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-2">Profile</h2>
      <p><strong>Name:</strong> <span id="user-name">Loading...</span></p>
      <p><strong>Email:</strong> <span id="user-email">Loading...</span></p>
      <p><strong>Avg. Response Time:</strong> <span id="user-response-time">--</span> sec</p>
      <p><strong>Progress:</strong></p>
      <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
        <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
      </div>
    </div>

    <!-- Skills Chart -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Skill Levels</h2>
      <div id="skills-container">Loading skills...</div>
    </div>

    <!-- Past Interviews -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ðŸ“œ Past Interviews</h2>
      <ul id="interviews-list" class="space-y-2 text-sm">Loading interview records...</ul>
    </div>

    <!-- Add Interview -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-semibold mb-4">âž• Add Interview Record</h2>
      <form id="add-interview-form" class="space-y-4">
        <input type="text" id="question" placeholder="Question" class="w-full p-2 border rounded" required />
        <input type="text" id="answer" placeholder="Answer" class="w-full p-2 border rounded" required />
        <input type="number" id="score" placeholder="Score out of 10" min="0" max="10" class="w-full p-2 border rounded" required />
        <input type="date" id="date" class="w-full p-2 border rounded" required />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Submit</button>
      </form>
    </div>
  </div>

  <script>
    // You can dynamically assign this using localStorage or sessionStorage after Google OAuth
    const email = sessionStorage.getItem("userEmail") || "test@example.com"; 
    const apiBase = "https://atharvpandey13-2006-github-io-interview-1-kq9g.onrender.com/api/user";

    fetch(`${apiBase}/${email}`)
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch user stats");
        return res.json();
      })
      .then(data => {
        document.getElementById("user-name").textContent = data.name || "N/A";
        document.getElementById("user-email").textContent = data.email;
        document.getElementById("user-response-time").textContent = data.avgResponseTime || 0;
        document.getElementById("progress-bar").style.width = (data.progress || 0) + "%";

        // Skills
        const skillContainer = document.getElementById("skills-container");
        skillContainer.innerHTML = "";
        if (data.skillLevels && Object.keys(data.skillLevels).length > 0) {
          Object.entries(data.skillLevels).forEach(([skill, level]) => {
            skillContainer.innerHTML += `
              <div class="mb-2">
                <span class="font-medium">${skill}</span>
                <div class="w-full bg-gray-200 h-3 rounded">
                  <div class="bg-green-500 h-3 rounded" style="width: ${level}%"></div>
                </div>
              </div>`;
          });
        } else {
          skillContainer.textContent = "No skills recorded.";
        }

        // Past interviews
        const interviewList = document.getElementById("interviews-list");
        interviewList.innerHTML = "";
        if (data.pastInterviews && data.pastInterviews.length > 0) {
          data.pastInterviews.reverse().forEach((intv, idx) => {
            interviewList.innerHTML += `
              <li class="bg-gray-50 p-4 rounded shadow-sm">
                <p><strong>Q:</strong> ${intv.question}</p>
                <p><strong>A:</strong> ${intv.answer}</p>
                <p><strong>Score:</strong> ${intv.score}/10 | <strong>Date:</strong> ${intv.date}</p>
              </li>`;
          });
        } else {
          interviewList.innerHTML = "<li>No past interviews found.</li>";
        }
      })
      .catch(err => {
        document.getElementById("user-name").textContent = "Error loading user";
        document.getElementById("skills-container").textContent = "Failed to load skills.";
        document.getElementById("interviews-list").textContent = "Failed to load interviews.";
        console.error(err);
      });

    document.getElementById("add-interview-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const record = {
        question: document.getElementById("question").value,
        answer: document.getElementById("answer").value,
        score: parseFloat(document.getElementById("score").value),
        date: document.getElementById("date").value,
      };

      fetch(`${apiBase}/${email}/addInterview`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(record),
      })
        .then(res => {
          if (res.ok) {
            alert("Interview added!");
            location.reload();
          } else {
            alert("Failed to add interview.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Server error. Try again later.");
        });
    });
  </script>
</body>
</html>
