<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard | Interview Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4 text-center">ðŸ‘¤ User Dashboard</h1>

    <!-- Profile Info -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-2">Profile</h2>
      <p><strong>Name:</strong> <span id="user-name">Loading...</span></p>
      <p><strong>Email:</strong> <span id="user-email">Loading...</span></p>
      <p><strong>Avg. Response Time:</strong> <span id="user-response-time">--</span> sec</p>
      <p><strong>Progress:</strong></p>
      <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
        <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
      </div>
    </div>

    <!-- Skills Chart -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Skill Levels</h2>
      <div id="skills-container">Loading skills...</div>
    </div>

    <!-- Past Interviews -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ðŸ“œ Past Interviews Score</h2>
      <ul id="interviews-list" class="space-y-2 text-sm">Loading interview records...</ul>
    </div>


  <script>
  // Refresh every 15 sec
  setInterval(() => {
    window.location.reload();
  }, 15000);

  const urlParams = new URLSearchParams(window.location.search);
  const userEmailFromURL = urlParams.get("email");
  const userNameFromURL = urlParams.get("name");

  if (userEmailFromURL) {
    sessionStorage.setItem("userEmail", userEmailFromURL);
  }
  if (userNameFromURL) {
  sessionStorage.setItem("userName", userNameFromURL); // ðŸ‘ˆ store name
}

  const email = sessionStorage.getItem("userEmail") || "atharv456pandey@gmail.com";
  const name = sessionStorage.getItem("userName") || "Unknown User"; // ðŸ‘ˆ fallback
  const apiBase = "https://atharvpandey13-2006-github-io-interview-1-kq9g.onrender.com/api/user";

  fetch(`${apiBase}/${email}`, {
    method: "GET",
    credentials: "include"
  })
    .then(res => {
      if (!res.ok) throw new Error("Failed to fetch user stats");
      return res.text();
    })
    .then(text => {
      if (!text) throw new Error("Empty response");
      const data = JSON.parse(text);

      // Profile Section
      document.getElementById("user-name").textContent = data.name || "N/A";
      document.getElementById("user-email").textContent = data.email || "N/A";
      document.getElementById("user-response-time").textContent = data.avgResponseTime || 0;
      document.getElementById("progress-bar").style.width = (data.progress || 0) + "%";

      // Skills
      const skillContainer = document.getElementById("skills-container");
      skillContainer.innerHTML = "";
      if (data.skillLevels && Object.keys(data.skillLevels).length > 0) {
        Object.entries(data.skillLevels).forEach(([skill, level]) => {
          skillContainer.innerHTML += `
            <div class="mb-2">
              <span class="font-medium">${skill}</span>
              <div class="w-full bg-gray-200 h-3 rounded">
                <div class="bg-green-500 h-3 rounded" style="width: ${level}%"></div>
              </div>
            </div>`;
        });
      } else {
        skillContainer.textContent = "No skills recorded.";
      }

      // Past Interviews
      const interviewList = document.getElementById("interviews-list");
      interviewList.innerHTML = "";
      if (data.pastInterviews && data.pastInterviews.length > 0) {
        const reversed = [...data.pastInterviews].reverse();
        reversed.forEach(intv => {
          interviewList.innerHTML += `
            <li class="bg-gray-50 p-4 rounded shadow-sm">
              <p><strong>Q:</strong> ${intv.question}</p>
              <p><strong>A:</strong> ${intv.answer}</p>
              <p><strong>Score:</strong> ${intv.score}/10 | <strong>Date:</strong> ${intv.date}</p>
            </li>`;
        });

        // âœ… Move Chart.js logic here, inside `.then()`
        const scores = reversed.map(i => i.score);
        const labels = reversed.map(i => {
          const d = new Date(i.date);
          return `${d.getDate()}/${d.getMonth() + 1}`;
        });

        const ctx = document.getElementById('scoreChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Interview Score',
              data: scores,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 5,
              pointHoverRadius: 7,
            }]
          },
          options: {
            scales: {
              y: {
                suggestedMin: 0,
                suggestedMax: 10,
                title: {
                  display: true,
                  text: 'Score (out of 10)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date'
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            }
          }
        });

      } else {
        interviewList.innerHTML = "<li>No past interviews found.</li>";
      }
    })
    .catch(err => {
      document.getElementById("user-name").textContent = "Error loading user";
      document.getElementById("skills-container").textContent = "Failed to load skills.";
      document.getElementById("interviews-list").textContent = "Failed to load interviews.";
      console.error("Dashboard error:", err);
    });
</script>

  <!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Score Chart -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
  <h2 class="text-xl font-semibold mb-4">ðŸ“Š Score Progress Over Time</h2>
  <canvas id="scoreChart" height="100"></canvas>
</div>

</body>
</html>
